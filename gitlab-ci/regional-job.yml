# Dynamic Regional Jobs using GitLab Child Pipelines (Shell Version)
# This approach generates region-specific jobs dynamically based on REGIONS variable
# Uses pure shell script - no Node.js dependencies

# Job to generate dynamic pipeline configuration using shell
generate-regional-pipeline:
  stage: pre
  image: alpine:latest
  services: []
  before_script:
    - echo "Starting regional pipeline generation..."
  script:
    - |
      if [ -z "$REGIONS" ]; then
        echo "Error: No REGIONS environment variable found"
        echo "Example: REGIONS='th,sg,my,jp'"
        exit 1
      fi

      # Ensure 'hk' is present in REGIONS
      if [ "$DEV_PIPELINE" != "true" ]; then
        if ! echo ",$REGIONS," | grep -q ",hk,"; then
          REGIONS="$REGIONS,hk"
        fi
      fi

      echo "ğŸš€ Generating pipeline for regions: $REGIONS"

      # Create the generated pipeline file
      cat > generated-regional-pipeline.yml << EOF
      # Auto-generated regional pipeline
      # Generated for regions: $REGIONS

      stages:
        - regional-build
        - regional-deploy

      EOF

      # Convert comma-separated regions to array (Alpine compatible)
      OLD_IFS="$IFS"
      IFS=','
      set -- $REGIONS
      IFS="$OLD_IFS"

      job_count=0

      for region in "$@"; do
        # Remove whitespace
        region=$(echo "$region" | tr -d ' ')

        if [ -n "$region" ]; then
          job_count=$((job_count + 2))

          # Generate build job
          cat >> generated-regional-pipeline.yml << EOF
      ${region}-web-build:
        stage: regional-build
        image: docker:stable
        services:
          - docker:stable-dind
        before_script: []
        variables:
          REGION_NAME: "$region"
        script:
          - echo "Building for region $region"
          - docker build . -t \$DOCKER_IMAGE_REPO:\$TAG-$region --build-arg GIT_USERNAME="\$GIT_USERNAME" --build-arg GIT_PASSWORD="\$GIT_PASSWORD" --build-arg BUILD="\$BUILD" --build-arg CI_COMMIT_SHA="\$CI_COMMIT_SHA" --build-arg APP_ENV="\$APP_ENV" --build-arg REACT_APP_REGION="$region" --build-arg REGION="$region"
          - docker save \$DOCKER_IMAGE_REPO:\$TAG-$region > image-$region.tar
        artifacts:
          paths:
            - image-$region.tar
          expire_in: 1 hour
        rules:
          - if: '\$BUILD'

      ${region}-web-deploy:
        stage: regional-deploy
        image: docker:stable
        services:
          - docker:stable-dind
        before_script:
          - echo \$GCP_SERVICE_ACCOUNT > /root/key.json
          - docker login -u _json_key --password-stdin https://asia.gcr.io < /root/key.json
          - rm -rf /root/key.json
        variables:
          REGION_NAME: "$region"
        script:
          - echo "Deploying for region $region"
          - docker load < image-$region.tar
          - docker push \$DOCKER_IMAGE_REPO:\$TAG-$region
          - |
            if [ -n "\$CI_COMMIT_TAG" ]; then
              docker tag \$DOCKER_IMAGE_REPO:\$TAG-$region \$DOCKER_IMAGE_REPO:\$CI_COMMIT_TAG-$region
              docker push \$DOCKER_IMAGE_REPO:\$CI_COMMIT_TAG-$region
            fi
          - |
            if [ "$region" = "hk" ]; then
              echo "Hong Kong region detected, pushing image without suffix"
              docker tag \$DOCKER_IMAGE_REPO:\$TAG-$region \$DOCKER_IMAGE_REPO:\$TAG
              docker push \$DOCKER_IMAGE_REPO:\$TAG
              if [ -n "\$CI_COMMIT_TAG" ]; then
                docker tag \$DOCKER_IMAGE_REPO:\$TAG-$region \$DOCKER_IMAGE_REPO:\$CI_COMMIT_TAG
                docker push \$DOCKER_IMAGE_REPO:\$CI_COMMIT_TAG
              fi
            fi
        needs:
          - ${region}-web-build
        rules:
          - if: '\$BUILD != null && \$BUILD != ""'

      EOF
        fi
      done

      echo "âœ… Generated $job_count jobs for regions: $REGIONS"
      echo "ğŸ“„ Pipeline written to: generated-regional-pipeline.yml"

      # Show the generated content for debugging
      echo "ğŸ“‹ Generated pipeline preview:"
      head -20 generated-regional-pipeline.yml
  artifacts:
    paths:
      - generated-regional-pipeline.yml
    expire_in: 1 hour
  rules:
    - if: '$REGIONS && $BUILD'

# Trigger the dynamically generated regional pipeline
trigger-regional-jobs:
  stage: pre
  needs:
    - generate-regional-pipeline
  trigger:
    include:
      - artifact: generated-regional-pipeline.yml
        job: generate-regional-pipeline
    strategy: depend
  rules:
    - if: '$REGIONS && $BUILD && $TAG && $DOCKER_IMAGE_REPO'

update-rollout-digests:
  stage: pre
  needs:
    - trigger-regional-jobs
  image: alpine:3.20
  variables:
    GIT_DEPTH: "0"      # éœ€è¦å®Œæ•´æ­·å²æ‰èƒ½ push
  before_script:
    - set -euo pipefail
    - apk add --no-cache bash git curl skopeo findutils

    # å®‰è£ yq (mikefarah ç‰ˆ)
    - curl -fsSL https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -o /usr/local/bin/yq
    - chmod +x /usr/local/bin/yq

    # Git èº«åˆ†ï¼ˆå¯æ”¹æˆä½ çš„ bot å¸³è™Ÿï¼‰
    - git config user.name  "gitlab-ci"
    - git config user.email "gitlab-ci@dimorder.com"
  script: |
    set -euo pipefail

    # === å°‹æ‰¾ manifest æª” ===
    pick_manifest() {
      # 1) æ ¹ç›®éŒ„å„ªå…ˆçš„å¸¸è¦‹æª”å
      for f in \
        "deployment.yaml" "deployment.yml" \
        "deploy.yaml" "deploy.yml"
      do
        if [ -f "$f" ]; then
          echo "$f"
          return 0
        fi
      done

      # 2) æ ¹ç›®éŒ„çš„ deploy é€šé… (deploy*.yaml / deploy*.yml)
      root_glob="$(ls -1 deploy*.ya?ml 2>/dev/null | head -n1 || true)"
      if [ -n "$root_glob" ]; then
        echo "$root_glob"
        return 0
      fi

      # 3) æ‰¾ç¬¬ä¸€å±¤å­ç›®éŒ„ï¼Œä¸éè¿´æ›´æ·±
      found="$(find . -maxdepth 2 -mindepth 2 -type f \
                  \( -name 'deployment.ya?ml' -o -name 'deploy*.ya?ml' \) \
                  | head -n1 || true)"
      if [ -n "$found" ]; then
        echo "$found"
      else
        echo "ERROR: No manifest file found (deployment.yaml, deploy.yaml, etc.)"
        exit 1
      fi
    }

    MANIFEST="$(pick_manifest)"
    echo "Using manifest: $MANIFEST"

    # Ensure 'hk' is present in REGIONS
    if [ "$DEV_PIPELINE" != "true" ]; then
      if ! echo ",$REGIONS," | grep -q ",hk,"; then
        REGIONS="$REGIONS,hk"
      fi
    fi

    # === é€ä¸€è™•ç† regions ===
    changed=0
    IFS=','
    for raw in $REGIONS; do
      # å»é™¤ç©ºç™½
      region="$(echo "$raw" | xargs)"
      [ -n "$region" ] || continue

      image_ref="${DOCKER_IMAGE_REPO}:${TAG}-${region}"
      echo "Resolving digest for: ${image_ref}"

      digest="$(skopeo inspect "${SKOPEO_CREDS[@]}" --format '{{.Digest}}' "docker://${image_ref}")"
      if [ -z "$digest" ]; then
        echo "ERROR: cannot resolve digest for ${image_ref}" >&2
        exit 1
      fi
      echo "  -> digest: ${digest}"

      yq -i 'select(.kind == "SimpleSite") .spec.buildImages.'"${region}"' = "'"${DOCKER_IMAGE_REPO}@${digest}"'"' "$MANIFEST"
      changed=1
    done


    # === æ›´æ–° ArgoCD repoURL ===
    yq -i "select(.kind == "SimpleSite") .spec.argocd.repoURL = \"$CI_REPOSITORY_URL\"" "$MANIFEST"

    if [ -z "$CI_COMMIT_TAG" ]; then
      yq -i "select(.kind == "SimpleSite") .spec.argocd.rapid = true" "$MANIFEST"
    else
      yq -i "select(.kind == "SimpleSite") .spec.argocd.rapid = false" "$MANIFEST"
    fi

    # === è‹¥æœ‰æ”¹å‹•å‰‡ commit + push ===
    if [ "$changed" -eq 1 ]; then
      git add "$MANIFEST"
      git commit -m "chore(ci): bump version"
      # æ¨å›ç›®å‰åˆ†æ”¯
      git push origin "$CI_COMMIT_REF_NAME"
      echo "Updated and pushed ${MANIFEST}"
    else
      echo "No changes to commit."
    fi
  rules:
    - if: '$REGIONS && $BUILD && $TAG && $DOCKER_IMAGE_REPO'
      exists:
        - deploy.yml
        - deployment.yaml
        - deploy.yaml
        - deployment.yml
    - when: never